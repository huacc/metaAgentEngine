# 工作流程

## 1. 流程总览

元智能体系统的完整工作流程分为 **7 个阶段**：

```
┌─────────────────────────────────────────────────────────────┐
│                      完整工作流程                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [1.需求捕获] → [2.情报搜集] → [3.资产比对] → [4.蓝图设计]   │
│                                                             │
│       → [5.实例化生产] → [6.执行与监控] → [7.闭环验收]       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 2. 阶段详解

### 2.1 需求捕获

**负责角色**：系统入口（可由简单的意图解析模块处理）

**输入**：用户的模糊意图

**处理**：
- 解析用户输入，提取关键信息
- 识别任务领域（医疗、开发、客服等）
- 初步判断任务复杂度

**输出**：
```json
{
  "raw_input": "我要一套代码审计流程",
  "parsed_intent": {
    "domain": "软件开发",
    "sub_domain": "安全审计",
    "task_type": "流程构建",
    "complexity": "medium"
  },
  "context": {
    "user_id": "user-001",
    "session_id": "sess-001"
  }
}
```

---

### 2.2 情报搜集（External）

**负责角色**：Librarian（情报官）

**输入**：解析后的意图

**处理**：
- 搜索该领域的最佳实践
- 收集行业标准和SOP
- 研究成熟案例

**输出**：
```json
{
  "domain": "代码安全审计",
  "best_practices": [
    "OWASP代码审查指南",
    "SAST+DAST组合策略"
  ],
  "recommended_roles": ["扫描员", "分析师", "修复建议员"],
  "common_pitfalls": ["误报率高", "漏报关键漏洞"],
  "confidence": 0.85
}
```

---

### 2.3 资产比对（Internal）

**负责角色**：Asset Manager（资产管家）

**输入**：解析后的意图 + Librarian 的报告

**处理**：
- 检索内部资产库
- 匹配现有 Agent 模板
- 计算复用率

**输出**：
```json
{
  "matched": true,
  "reusable_agents": [
    {"name": "代码扫描员-v1.2", "match_score": 0.9},
    {"name": "安全分析师-v2.0", "match_score": 0.75}
  ],
  "reusable_workflows": ["安全审计流程-v1.0"],
  "reuse_rate": 0.6,
  "gaps": ["缺少修复建议员"]
}
```

---

### 2.4 蓝图设计

**负责角色**：Architect（架构师）

**输入**：Librarian + Asset Manager 的合并报告

**处理**：
- 设计智能体列表和职责边界
- 定义 I/O 契约
- 确定工作流类型

**输出**：
```json
{
  "blueprint_name": "代码审计流程-v1.1",
  "agents": [
    {"name": "扫描员", "source": "复用", "version": "1.2"},
    {"name": "分析师", "source": "复用", "version": "2.0"},
    {"name": "修复建议员", "source": "新建", "version": "1.0"}
  ],
  "workflow_type": "seq",
  "contracts": {...}
}
```

---

### 2.5 实例化生产

**负责角色**：Weaver（织造者）+ Choreographer（编排官）

**并行处理**：

**Weaver 的工作**：
- 为新建 Agent 编写 Prompt
- 为复用 Agent 微调 Prompt

**Choreographer 的工作**：
- 构建协作拓扑
- 定义数据流转规则

**输出**：
```json
{
  "agents_config": [
    {
      "name": "修复建议员",
      "system_prompt": "你是安全修复专家...",
      "tools": ["code_search", "patch_generator"]
    }
  ],
  "workflow_config": {
    "topology": "DAG",
    "nodes": [...],
    "transitions": [...]
  }
}
```

---

### 2.6 执行与监控

**负责角色**：Orchestrator（协调者，运行时角色）

**处理**：
- 按拓扑调度 Agent 执行
- 传递上下文和数据
- 监控执行状态
- 处理异常和重试

**输出**：
```json
{
  "execution_id": "exec-001",
  "status": "completed",
  "results": [
    {"agent": "扫描员", "status": "success", "output": {...}},
    {"agent": "分析师", "status": "success", "output": {...}},
    {"agent": "修复建议员", "status": "success", "output": {...}}
  ],
  "duration_ms": 15000
}
```

---

### 2.7 闭环验收

**负责角色**：Evaluator（评估官）

**处理**：
- 评估执行结果质量
- 决定通过或打回
- 通过后存入资产库

**输出**：
```json
{
  "evaluation": {
    "score": 0.88,
    "pass": true,
    "feedback": ["整体质量良好"]
  },
  "action": "approve_and_archive",
  "archived_assets": [
    "修复建议员-v1.0",
    "代码审计流程-v1.1"
  ]
}
```

---

## 3. 流程图总结

```
用户意图
    ↓
┌─────────────────────────────────────────────────────┐
│ [1] 需求捕获                                         │
└─────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────┐
│ [2] Librarian ←──并行──→ [3] Asset Manager          │
│     (外部情报)              (内部资产)               │
└─────────────────────────────────────────────────────┘
    ↓ 合并报告
┌─────────────────────────────────────────────────────┐
│ [4] Architect (蓝图设计)                             │
└─────────────────────────────────────────────────────┘
    ↓ 蓝图
┌─────────────────────────────────────────────────────┐
│ [5] Weaver ←──并行──→ Choreographer                 │
│     (Prompt)            (流程)                       │
└─────────────────────────────────────────────────────┘
    ↓ 完整配置
┌─────────────────────────────────────────────────────┐
│ [6] 执行与监控                                       │
└─────────────────────────────────────────────────────┘
    ↓ 结果
┌─────────────────────────────────────────────────────┐
│ [7] Evaluator (验收)                                 │
│     ├─ 通过 → 存入资产库 → 交付用户                  │
│     └─ 不通过 → 打回重修                             │
└─────────────────────────────────────────────────────┘
```
