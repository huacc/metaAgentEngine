# 元智能体引擎方法论 v1.0

## 目录

1. [概述](#1-概述)
2. [元智能体体系](#2-元智能体体系)
3. [记忆系统](#3-记忆系统)
4. [个人知识库](#4-个人知识库)
5. [多任务协同](#5-多任务协同)
6. [上下文管理](#6-上下文管理)
7. [工具集成](#7-工具集成)
8. [可观测性](#8-可观测性)

---

## 1. 概述

### 1.1 核心愿景

构建一套**"生产智能体的智能体系统"**——元智能体引擎（Meta-Agent Engine）。

### 1.2 核心能力

| 能力 | 说明 |
|------|------|
| **生产** | 根据用户意图，自动生产业务智能体 |
| **派生** | 支持智能体的层级派生，从通用到专业逐级深化 |
| **协同** | 多智能体按标准化流程协作完成任务 |
| **记忆** | 长期存储知识、经验、用户偏好 |
| **学习** | 从历史执行中学习，持续优化 |
| **个性化** | 基于用户个人知识库定制智能体 |

### 1.3 系统架构总览

```
┌─────────────────────────────────────────────────────────────┐
│                     元智能体引擎                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 元智能体体系 │  │  记忆系统   │  │ 个人知识库  │         │
│  │  (8角色)    │  │ (长期/短期) │  │ (用户经验)  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 多任务协同  │  │ 上下文管理  │  │  工具集成   │         │
│  │ (队列/调度) │  │ (会话/状态) │  │ (MCP/API)  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ┌─────────────────────────────────────────────────┐       │
│  │                  可观测性                        │       │
│  │            (日志/监控/追踪/审计)                 │       │
│  └─────────────────────────────────────────────────┘       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 元智能体体系

### 2.1 智能体标准结构

每个智能体必须包含以下组成部分：

```
┌─────────────────────────────────────────┐
│              智能体结构                  │
├─────────────────────────────────────────┤
│  1. 基础信息 (Meta)                      │
│     - ID、名称、版本、状态               │
├─────────────────────────────────────────┤
│  2. 角色定义 (Role)                      │
│     - 角色描述、职能边界                 │
├─────────────────────────────────────────┤
│  3. 提示词 (Prompt)                      │
│     - System Prompt模板                  │
├─────────────────────────────────────────┤
│  4. 技能 (Skills)                        │
│     - 内在技能、外部技能                 │
├─────────────────────────────────────────┤
│  5. 输入输出 (I/O Contract)              │
│     - 输入规范、输出规范                 │
├─────────────────────────────────────────┤
│  6. 约束 (Constraints)                   │
│     - 能做什么、不能做什么               │
└─────────────────────────────────────────┘
```

**智能体标准JSON结构**：

```json
{
  "meta": {
    "id": "agent-001",
    "name": "Researcher",
    "name_cn": "情报研究员",
    "version": "1.0.0",
    "group": "情报组",
    "status": "active"
  },
  "role": {
    "description": "检索外部最佳实践、行业标准、前沿方法",
    "boundary": {
      "can_do": ["搜索", "分析", "总结"],
      "cannot_do": ["架构决策", "写Prompt"]
    }
  },
  "prompt": {
    "system_template": "...",
    "variables": ["DOMAIN", "USER_QUERY"]
  },
  "skills": {
    "internal": ["领域分析", "知识提纯"],
    "external": ["web_search", "rag_retrieval"]
  },
  "io_contract": {
    "input": {"type": "object", "schema": {}},
    "output": {"type": "object", "schema": {}}
  },
  "constraints": ["只提供情报，不做决策"]
}
```

**Skill标准结构**：

```json
{
  "skill_id": "web_search",
  "name": "网络搜索",
  "type": "external",
  "description": "搜索互联网获取最新信息",
  "parameters": {
    "query": {"type": "string", "required": true},
    "max_results": {"type": "integer", "default": 10}
  },
  "returns": {
    "type": "array",
    "items": {"title": "string", "url": "string", "snippet": "string"}
  },
  "permissions": ["network_access"]
}
```

### 2.2 角色详细定义

#### 2.2.1 Researcher（情报研究员）

**角色定义**：
| 项目 | 内容 |
|------|------|
| 职能组 | 情报组 |
| 核心职责 | 检索外部最佳实践、行业标准、前沿方法 |
| 上游依赖 | 用户意图 |
| 下游输出 | Architect |

**职能边界**：
| 能做 | 不能做 |
|------|--------|
| 搜索互联网 | 架构决策 |
| 分析文献 | 写Prompt |
| 总结最佳实践 | 设计流程 |
| 识别风险点 | 执行任务 |

**输入规范**：
```json
{
  "domain": "医疗问诊",
  "user_query": "构建一套智能问诊系统",
  "context": {"existing_agents": [], "constraints": []}
}
```

**输出规范**：
```json
{
  "domain": "医疗问诊",
  "best_practices": ["SOAP记录法", "分诊标准"],
  "recommended_roles": ["分诊员", "问诊员", "诊断员"],
  "common_pitfalls": ["漏问病史", "误诊风险"],
  "sources": ["https://..."],
  "confidence": 0.85
}
```

**提示词模板**：
```
你是一个专业的领域研究员兼情报分析师。

## 任务
用户当前任务领域是：[DOMAIN]
具体任务描述：[USER_QUERY]

## 要求
请从以下维度全面收集并总结该领域的最佳实践：
1. 当前最主流的技术栈/方法论/流程
2. 顶级公司或项目的成熟实践案例
3. 推荐的子智能体分工结构
4. 常见失败模式和风险点
5. 关键工具推荐

## 输出格式
严格使用JSON格式输出。

## 约束
- 只提供事实和数据，不进行架构决策
- 优先引用权威来源
- 标注信息的置信度
```

**Skills**：
| 技能 | 类型 | 说明 |
|------|------|------|
| 领域分析 | 内在 | 识别任务所属领域 |
| 知识提纯 | 内在 | 从噪音中提取关键信息 |
| web_search | 外部 | 搜索互联网 |
| rag_retrieval | 外部 | RAG检索知识库 |

---

#### 2.2.2 Asset Manager（资产管家）

**角色定义**：
| 项目 | 内容 |
|------|------|
| 职能组 | 情报组 |
| 核心职责 | 管理内部Agent模板、Prompt组件、流程蓝图 |
| 上游依赖 | 用户意图 |
| 下游输出 | Architect |

**职能边界**：
| 能做 | 不能做 |
|------|--------|
| 检索资产库 | 创造新资产 |
| 匹配模板 | 修改资产 |
| 版本管理 | 架构决策 |
| 推荐组合 | 执行任务 |

**输入规范**：
```json
{
  "user_query": "构建智能问诊系统",
  "system_context": {"existing_agents": ["通用医生-v1.0"]}
}
```

**输出规范**：
```json
{
  "matched": true,
  "reusable_agents": ["问诊员-v2.1", "诊断员-v1.3"],
  "reusable_workflows": ["医疗问诊流程-v1.0"],
  "reuse_rate": 0.7,
  "gaps": ["缺少分诊员"]
}
```

**提示词模板**：
```
你是系统模板检索专家。

## 任务
给定用户查询[USER_QUERY]和系统上下文[SYSTEM_CONTEXT]，检索匹配的最佳资产组合。

## 步骤
1. 分析查询领域和需求
2. 从资产库中匹配：现有角色、Prompt组合、流程模式
3. 如果匹配，提供现成配置
4. 如果不匹配，标注缺口

## 原则
- 复用优先，避免冗余
- 优先推荐高评分资产
- 标注版本兼容性
```

**Skills**：
| 技能 | 类型 | 说明 |
|------|------|------|
| 语义匹配 | 内在 | 理解查询意图 |
| 组合推荐 | 内在 | 推荐资产组合 |
| asset_search | 外部 | 检索资产库 |
| version_check | 外部 | 版本兼容检查 |

---

#### 2.2.3 Architect（架构师）

**角色定义**：
| 项目 | 内容 |
|------|------|
| 职能组 | 设计组 |
| 核心职责 | 拆解意图，设计智能体蓝图和I/O契约 |
| 上游依赖 | Researcher + Asset Manager |
| 下游输出 | Weaver + Choreographer |

**职能边界**：
| 能做 | 不能做 |
|------|--------|
| 设计架构 | 写Prompt |
| 定义角色 | 设计流程细节 |
| 划分边界 | 执行任务 |
| 定义契约 | 质量评估 |

**输入规范**：
```json
{
  "researcher_report": {...},
  "asset_report": {...},
  "user_constraints": []
}
```

**输出规范**：
```json
{
  "blueprint_name": "医疗问诊系统",
  "agents": [
    {"name": "分诊员", "role": "初步分类", "input": "症状", "output": "科室"}
  ],
  "contracts": {"分诊员→问诊员": "患者信息+科室"},
  "workflow_type": "seq"
}
```

**提示词模板**：
```
你是首席系统架构师。

## 任务
基于情报报告和资产匹配结果，将用户需求转化为智能体协作蓝图。

## 输出要求
必须产出JSON格式，包含：
- Agent_List: 每个智能体的名称、角色、目标
- IO_Contract: 输入输出契约
- Workflow_Type: seq/par/hybrid

## 原则
- 高内聚低耦合
- 每个Agent只做一件事
- 明确边界，避免职责重叠
```

**Skills**：
| 技能 | 类型 | 说明 |
|------|------|------|
| 任务分解 | 内在 | 拆解复杂任务 |
| 边界定义 | 内在 | 划分职责边界 |
| 契约设计 | 内在 | 定义I/O规范 |

---

#### 2.2.4 Weaver（织造者）

**角色定义**：
| 项目 | 内容 |
|------|------|
| 职能组 | 设计组 |
| 核心职责 | 编写System Prompt，赋予智能体灵魂 |
| 上游依赖 | Architect |
| 下游输出 | Choreographer |

**职能边界**：
| 能做 | 不能做 |
|------|--------|
| 写Prompt | 设计架构 |
| 注入性格 | 设计流程 |
| 设计思维框架 | 执行任务 |
| 定义输出格式 | 质量评估 |

**输出规范**：
```json
{
  "agent_name": "分诊员",
  "system_prompt": "你是一名经验丰富的分诊护士...",
  "components": {
    "role_play": "分诊护士，10年经验",
    "task_context": "根据症状进行初步分类",
    "thinking_process": "先问主诉，再问病史",
    "output_constraint": "输出JSON格式"
  }
}
```

**提示词模板**：
```
你是提示词专家。

## 任务
根据架构师的蓝图，为每个Agent编写System Prompt。

## Prompt必须包含
1. Role-Play: 角色扮演设定
2. Task-Context: 任务上下文
3. Thinking-Process: 思维过程(CoT)
4. Output-Constraint: 输出约束

## 原则
- 确保Agent具备强烈的行业属性
- 注入"拒绝处理范围外任务"的自我认知
- 使用Few-Shot示例优化效果
```

**Skills**：
| 技能 | 类型 | 说明 |
|------|------|------|
| Prompt工程 | 内在 | 编写高质量Prompt |
| 角色塑造 | 内在 | 注入性格特征 |
| Few-Shot设计 | 内在 | 设计示例 |

---

#### 2.2.5 Choreographer（编排者）

**角色定义**：
| 项目 | 内容 |
|------|------|
| 职能组 | 执行组 |
| 核心职责 | 设计协作拓扑（DAG/状态机），定义数据流转 |
| 上游依赖 | Architect + Weaver |
| 下游输出 | Orchestrator |

**职能边界**：
| 能做 | 不能做 |
|------|--------|
| 设计流程拓扑 | 写Prompt |
| 定义状态转移 | 运行时执行 |
| 设计异常处理 | 质量评估 |

**输出规范**：
```json
{
  "topology": "DAG",
  "nodes": [
    {"id": "triage", "agent": "分诊员", "next": ["inquiry"]}
  ],
  "transitions": [
    {"from": "triage", "to": "inquiry", "condition": "success"}
  ],
  "error_handling": {"on_failure": "retry_then_escalate"}
}
```

**Skills**：
| 技能 | 类型 | 说明 |
|------|------|------|
| 流程建模 | 内在 | DAG/状态机设计 |
| 条件逻辑 | 内在 | 分支条件设计 |

---

#### 2.2.6 Orchestrator（调度者）

**角色定义**：
| 项目 | 内容 |
|------|------|
| 职能组 | 执行组 |
| 核心职责 | 运行时调度执行，管理上下文传递 |
| 上游依赖 | Choreographer |
| 下游输出 | Evaluator |

**职能边界**：
| 能做 | 不能做 |
|------|--------|
| 调度执行 | 修改流程设计 |
| 传递上下文 | 修改Prompt |
| 异常处理 | 质量评估 |
| 重试机制 | 架构决策 |

**输出规范**：
```json
{
  "execution_id": "exec-001",
  "status": "completed",
  "results": [
    {"agent": "分诊员", "status": "success", "output": {...}}
  ],
  "duration_ms": 5000
}
```

**Skills**：
| 技能 | 类型 | 说明 |
|------|------|------|
| 任务调度 | 内在 | 按拓扑执行 |
| 上下文路由 | 内在 | 数据传递 |
| agent_invoke | 外部 | 调用Agent |

---

#### 2.2.7 Evaluator（评估者）

**角色定义**：
| 项目 | 内容 |
|------|------|
| 职能组 | 运维组 |
| 核心职责 | 质量评估，拥有最终否决权 |
| 上游依赖 | Orchestrator |
| 下游输出 | Learner / Asset Manager |

**职能边界**：
| 能做 | 不能做 |
|------|--------|
| 评估质量 | 直接修改 |
| 打分反馈 | 执行任务 |
| 否决不合格 | 架构决策 |

**输出规范**：
```json
{
  "scores": {"accuracy": 0.9, "completeness": 0.85},
  "overall": 0.87,
  "pass": true,
  "feedback": ["整体良好"],
  "action": "approve"
}
```

**Skills**：
| 技能 | 类型 | 说明 |
|------|------|------|
| 评分标准 | 内在 | 应用rubric |
| 对抗测试 | 内在 | 模拟极端情况 |

---

#### 2.2.8 Learner（学习者）

**角色定义**：
| 项目 | 内容 |
|------|------|
| 职能组 | 运维组 |
| 核心职责 | 从历史中提取模式，优化系统 |
| 上游依赖 | Evaluator |
| 下游输出 | 优化建议 → 各角色 |

**职能边界**：
| 能做 | 不能做 |
|------|--------|
| 分析历史 | 直接修改系统 |
| 提取模式 | 执行任务 |
| 提优化建议 | 强制变更 |

**输出规范**：
```json
{
  "patterns": ["问诊先问主诉效果更好"],
  "suggestions": {
    "prompt": ["分诊员增加急症识别"],
    "workflow": ["增加复诊分支"]
  }
}
```

**Skills**：
| 技能 | 类型 | 说明 |
|------|------|------|
| 模式识别 | 内在 | 从历史提取规律 |
| 优化建议 | 内在 | 生成改进方案 |

---

### 2.3 用例场景

#### 场景1：医疗问诊系统

**用户输入**："我要构建一套智能问诊系统"

**执行流程**：
```
1. Researcher: 搜索医疗问诊最佳实践（SOAP记录法、分诊标准）
2. Asset Manager: 匹配已有"通用医生-v1.0"模板
3. Architect: 设计蓝图 → 分诊员、问诊员、诊断员
4. Weaver: 为每个角色编写Prompt
5. Choreographer: 设计流程 → 分诊→问诊→诊断
6. Orchestrator: 执行测试
7. Evaluator: 评估通过，存入资产库
```

**产出**：3个业务智能体 + 1套协作流程

---

#### 场景2：代码审计流程

**用户输入**："我要一套代码安全审计流程"

**执行流程**：
```
1. Researcher: 搜索OWASP标准、SAST/DAST实践
2. Asset Manager: 匹配已有"代码分析员-v1.2"
3. Architect: 设计蓝图 → 扫描员、分析员、修复建议员
4. Weaver: 编写安全领域Prompt
5. Choreographer: 设计流程 → 扫描→分析→建议
6. Evaluator: 评估通过
```

**产出**：3个业务智能体 + 1套审计流程

### 2.1 角色矩阵

系统定义 **8 个核心元角色**，分为 4 个职能组：

| 职能组 | 角色 | 中文名 | 核心职责 |
|--------|------|--------|----------|
| **情报组** | Researcher | 情报研究员 | 检索外部最佳实践、行业标准 |
| | Asset Manager | 资产管家 | 管理内部Agent模板、Prompt组件 |
| **设计组** | Architect | 架构师 | 拆解意图，设计智能体蓝图 |
| | Weaver | 织造者 | 编写System Prompt |
| **执行组** | Choreographer | 编排者 | 设计协作拓扑（DAG/状态机） |
| | Orchestrator | 调度者 | 运行时调度执行 |
| **运维组** | Evaluator | 评估者 | 质量评估，拥有否决权 |
| | Learner | 学习者 | 从历史中提取模式 |

### 2.2 协同流程

```
用户意图 → [Researcher + Asset Manager] → [Architect] → [Weaver + Choreographer] → [Orchestrator] → [Evaluator] → [Learner]
```

### 2.3 层级派生机制

**核心公式**：派生 = 继承 + 特化 + 约束

| 层级 | 说明 | 示例 |
|------|------|------|
| L0 | 通用智能体 | 医生 |
| L1 | 领域智能体 | 内科医生 |
| L2 | 专科智能体 | 胃肠科医生 |
| L3 | 细分智能体 | 胃镜专家 |

**触发条件**：粒度不足、质量不达标、频率阈值

> 详细定义见附录A

---

## 3. 记忆系统

### 3.1 记忆分层

| 层级 | 类型 | 存储周期 | 用途 |
|------|------|----------|------|
| L1 | **工作记忆** | 单次会话 | 当前任务上下文 |
| L2 | **短期记忆** | 跨会话（天级） | 近期交互历史 |
| L3 | **长期记忆** | 持久化 | 知识、经验、模式 |

### 3.2 存储方案

| 记忆类型 | 存储技术 | 检索方式 |
|----------|----------|----------|
| 结构化知识 | 知识图谱 | 图查询 |
| 非结构化内容 | 向量数据库 | 语义检索 |
| 执行历史 | 关系数据库 | SQL查询 |
| 用户偏好 | KV存储 | 键值查询 |

### 3.3 记忆生命周期

```
输入 → 编码 → 存储 → 检索 → 遗忘/强化
```

> TODO: 详细设计待补充

---

## 4. 个人知识库

### 4.1 核心问题

**如何让元智能体快速了解一个人？**

### 4.2 知识来源

| 来源 | 方式 | 说明 |
|------|------|------|
| **主动注入** | 用户上传 | 文档、方法论、经验总结 |
| **交互学习** | 对话提取 | 从历史对话中提取偏好 |
| **反馈学习** | 修正记录 | 用户对输出的修正和评价 |
| **行为观察** | 模式识别 | 决策模式、习惯 |

### 4.3 知识优先级

Researcher查询顺序：
1. **个人知识库** → 用户自己的经验（最高优先）
2. **Asset Manager** → 系统已有资产
3. **互联网** → 外部最佳实践（最低优先）

### 4.4 个人画像结构

```json
{
  "user_id": "user-001",
  "domains": ["软件开发", "项目管理"],
  "methodologies": ["敏捷", "DDD"],
  "preferences": {"output_format": "简洁", "detail_level": "高"},
  "decision_patterns": [...],
  "custom_agents": [...]
}
```

> TODO: 个人知识库详细设计待补充

---

## 5. 多任务协同

### 5.1 任务模型

| 维度 | 说明 |
|------|------|
| **任务队列** | 待执行任务的有序列表 |
| **优先级** | 紧急/高/中/低 |
| **依赖关系** | 任务间的前置条件 |
| **并发控制** | 最大并行任务数 |

### 5.2 调度策略

| 策略 | 适用场景 |
|------|----------|
| FIFO | 默认，先进先出 |
| 优先级调度 | 有紧急任务时 |
| 依赖调度 | 任务间有依赖时 |

### 5.3 任务状态

```
pending → running → completed / failed
```

> TODO: 多任务协同详细设计待补充

---

## 6. 上下文管理

### 6.1 上下文类型

| 类型 | 作用域 | 说明 |
|------|--------|------|
| **会话上下文** | 单次会话 | 当前对话的历史 |
| **任务上下文** | 单个任务 | 任务执行的中间状态 |
| **用户上下文** | 跨会话 | 用户偏好、历史 |
| **全局上下文** | 系统级 | 系统配置、共享知识 |

### 6.2 上下文传递

```
Agent A → [上下文路由] → Agent B
              ↓
         过滤/转换/压缩
```

> TODO: 上下文管理详细设计待补充

---

## 7. 工具集成

### 7.1 工具类型

| 类型 | 说明 | 示例 |
|------|------|------|
| **内置工具** | 系统自带 | 文件读写、搜索 |
| **MCP工具** | 标准协议 | 第三方MCP服务 |
| **API工具** | 外部接口 | REST/GraphQL |
| **自定义工具** | 用户扩展 | 脚本、插件 |

### 7.2 工具注册

```json
{
  "tool_id": "web_search",
  "name": "网络搜索",
  "protocol": "MCP",
  "endpoint": "...",
  "permissions": ["read"]
}
```

> TODO: 工具集成详细设计待补充

---

## 8. 可观测性

### 8.1 观测维度

| 维度 | 说明 |
|------|------|
| **日志** | 执行过程记录 |
| **监控** | 性能指标、健康状态 |
| **追踪** | 请求链路追踪 |
| **审计** | 操作记录、合规检查 |

### 8.2 关键指标

| 指标 | 说明 |
|------|------|
| 任务成功率 | 完成/总数 |
| 平均响应时间 | 从请求到响应 |
| Agent调用次数 | 各Agent使用频率 |
| 派生触发次数 | 新智能体生成频率 |

> TODO: 可观测性详细设计待补充

---

## 附录

### 附录A：元智能体详细定义

> 包含8个角色的完整Prompt模板、输入输出规范、技能列表、边界定义
>
> TODO: 待补充

### 附录B：数据结构定义

> 包含Agent、Blueprint、Workflow、Execution等核心数据结构
>
> TODO: 待补充

---

## 版本记录

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2025-02-01 | 初始版本，建立章节框架 |
