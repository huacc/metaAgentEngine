# 层级派生机制

## 1. 核心概念

### 1.1 什么是层级派生

层级派生是指智能体像**生物进化**一样，从通用到专业逐级分化的机制：

```
通用智能体 (Generalist)
    ↓ 派生
领域智能体 (Domain Expert)
    ↓ 派生
专科智能体 (Specialist)
    ↓ 派生
细分智能体 (Sub-specialist)
```

### 1.2 派生的本质

派生 = **继承** + **特化** + **约束**

| 维度 | 说明 | 示例 |
|------|------|------|
| **继承** | 子智能体获得父智能体的基础能力 | 胃肠科医生继承内科医生的问诊能力 |
| **特化** | 在特定领域深化专业能力 | 增加胃镜解读、幽门螺杆菌诊断能力 |
| **约束** | 缩小职责边界，明确能力范围 | 只处理消化系统疾病，其他转诊 |

## 2. 派生树结构

### 2.1 医疗场景示例

```
医生智能体 (L0)
├── 内科医生 (L1)
│   ├── 胃肠科医生 (L2)
│   │   ├── 胃镜专家 (L3)
│   │   └── 肠镜专家 (L3)
│   ├── 心血管科医生 (L2)
│   └── 呼吸科医生 (L2)
├── 外科医生 (L1)
│   ├── 骨科医生 (L2)
│   └── 神经外科医生 (L2)
└── 儿科医生 (L1)
    ├── 儿童内科医生 (L2)
    └── 儿童外科医生 (L2)
```

### 2.2 软件开发场景示例

```
开发者智能体 (L0)
├── 前端开发者 (L1)
│   ├── React专家 (L2)
│   ├── Vue专家 (L2)
│   └── 移动端专家 (L2)
│       ├── iOS专家 (L3)
│       └── Android专家 (L3)
├── 后端开发者 (L1)
│   ├── Java专家 (L2)
│   ├── Python专家 (L2)
│   └── Go专家 (L2)
└── 运维工程师 (L1)
    ├── K8s专家 (L2)
    └── 数据库专家 (L2)
```

## 3. 派生规则

### 3.1 触发条件

什么时候需要派生新的子智能体？

| 触发条件 | 说明 | 示例 |
|----------|------|------|
| **粒度不足** | 当前智能体无法处理细分问题 | 内科医生遇到复杂胃病，需要胃肠科专家 |
| **专业度要求** | 任务需要更深的专业知识 | 通用开发者无法优化React性能 |
| **频率阈值** | 某类子任务频繁出现 | 经常需要处理K8s问题，值得派生专家 |
| **质量不达标** | 通用智能体处理效果不佳 | Evaluator反馈准确率低于阈值 |

### 3.2 派生流程

```
┌─────────────────────────────────────────┐
│  1. 识别派生需求                          │
│     - Evaluator 发现质量问题              │
│     - 或 Orchestrator 发现能力缺口        │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  2. 确定派生方向                          │
│     - Librarian 研究该细分领域            │
│     - Architect 设计子智能体边界          │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  3. 执行派生                              │
│     - 复制父智能体基础配置                 │
│     - Weaver 编写特化 Prompt              │
│     - 注入领域知识和约束                   │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│  4. 验证与注册                            │
│     - Evaluator 验证子智能体能力          │
│     - Asset Manager 注册到资产库          │
│     - 建立父子关系索引                     │
└─────────────────────────────────────────┘
```

## 4. 继承机制

### 4.1 可继承的元素

| 元素 | 继承方式 | 说明 |
|------|----------|------|
| **基础Prompt** | 完全继承 | 角色定义、思维框架 |
| **通用技能** | 完全继承 | 问诊、分析、输出格式 |
| **领域知识** | 部分继承 | 继承相关部分，忽略无关部分 |
| **工具权限** | 选择继承 | 根据需要增减工具 |
| **约束规则** | 继承+追加 | 在父级约束基础上增加新约束 |

### 4.2 继承示例

**父智能体：内科医生**
```json
{
  "name": "内科医生",
  "base_prompt": "你是一名内科医生，擅长诊断和治疗内科疾病...",
  "skills": ["问诊", "体格检查", "开具检查单", "诊断", "开药"],
  "knowledge_domains": ["内科学", "诊断学", "药理学"],
  "constraints": ["不做手术", "复杂病例转诊"]
}
```

**子智能体：胃肠科医生**（派生后）
```json
{
  "name": "胃肠科医生",
  "parent": "内科医生",
  "base_prompt": "你是一名胃肠科专家，专注于消化系统疾病...",
  "skills": ["问诊", "体格检查", "开具检查单", "诊断", "开药",
             "胃镜报告解读", "肠镜报告解读", "幽门螺杆菌诊断"],
  "knowledge_domains": ["内科学", "诊断学", "药理学",
                        "消化内科学", "内镜学"],
  "constraints": ["不做手术", "复杂病例转诊",
                  "只处理消化系统疾病", "非消化问题转回内科"]
}
```

## 5. 动态派生

### 5.1 运行时派生

系统在执行任务过程中，可以**动态**发现需要派生新智能体：

```
任务执行中
    ↓
发现能力缺口（Orchestrator 检测）
    ↓
评估是否值得派生（频率、重要性）
    ↓
  ┌─────┴─────┐
  ↓           ↓
临时派生    永久派生
(一次性)   (存入资产库)
```

### 5.2 派生决策矩阵

| 出现频率 | 任务重要性 | 决策 |
|----------|------------|------|
| 低 | 低 | 不派生，父智能体处理 |
| 低 | 高 | 临时派生，用完销毁 |
| 高 | 低 | 考虑派生，观察一段时间 |
| 高 | 高 | 立即永久派生 |

## 6. 族谱管理

### 6.1 智能体族谱

Asset Manager 维护完整的智能体族谱：

```json
{
  "agent_id": "gastro-doctor-001",
  "name": "胃肠科医生",
  "version": "1.2.0",
  "lineage": {
    "parent": "internal-medicine-001",
    "grandparent": "doctor-001",
    "root": "doctor-001"
  },
  "children": ["gastroscopy-expert-001", "colonoscopy-expert-001"],
  "created_at": "2024-01-15",
  "created_by": "派生请求#1234",
  "performance_stats": {
    "total_tasks": 1520,
    "success_rate": 0.94,
    "avg_quality_score": 0.89
  }
}
```

### 6.2 版本演进

智能体可以在不派生的情况下**升级**：

| 变更类型 | 版本号变化 | 示例 |
|----------|------------|------|
| 修复Bug | x.x.+1 | 1.2.0 → 1.2.1 |
| 增强能力 | x.+1.0 | 1.2.0 → 1.3.0 |
| 重大重构 | +1.0.0 | 1.2.0 → 2.0.0 |

## 7. 协作与路由

### 7.1 层级间协作

```
用户问题："我最近胃疼，还有点心慌"

医生智能体(L0) 接收
    ↓ 初步分诊
    ↓
┌───────────────┬───────────────┐
↓               ↓
内科医生(L1)    内科医生(L1)
处理胃疼        处理心慌
    ↓               ↓
胃肠科(L2)      心血管科(L2)
深入诊断        深入诊断
    ↓               ↓
└───────────────┴───────────────┘
    ↓ 汇总
医生智能体(L0) 整合诊断结果
```

### 7.2 路由规则

| 场景 | 路由策略 |
|------|----------|
| 问题明确属于某专科 | 直接路由到专科智能体 |
| 问题涉及多个专科 | 并行分发，结果汇总 |
| 问题超出当前层级能力 | 向下派生或向上回退 |
| 专科智能体不存在 | 触发派生流程 |
