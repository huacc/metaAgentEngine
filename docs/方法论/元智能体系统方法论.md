# 元智能体系统方法论 v1.0

## 1. 核心愿景

构建一套**"生产智能体的智能体系统"**——元智能体引擎（Meta-Agent Engine）。

核心能力：
- **生产**：根据用户意图，自动生产业务智能体
- **派生**：支持智能体的层级派生，从通用到专业逐级深化
- **协同**：多智能体按标准化流程协作完成任务
- **进化**：从历史执行中学习，持续优化

## 2. 元智能体角色矩阵

系统定义 **8 个核心元角色**，分为 4 个职能组：

```
┌─────────────────────────────────────────────────────────────┐
│                      元智能体层 (8角色)                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  【情报组】              【设计组】                           │
│  ┌──────────────┐       ┌──────────────┐                   │
│  │  Researcher  │──────→│  Architect   │                   │
│  │   情报研究员  │       │    架构师     │                   │
│  └──────────────┘       └──────────────┘                   │
│         ↑                      ↓                           │
│  ┌──────────────┐       ┌──────────────┐                   │
│  │Asset Manager │       │    Weaver    │                   │
│  │   资产管家    │       │    织造者     │                   │
│  └──────────────┘       └──────────────┘                   │
│         ↑                      ↓                           │
│  【运维组】              【执行组】                           │
│  ┌──────────────┐       ┌──────────────┐                   │
│  │   Learner    │       │Choreographer │                   │
│  │    学习者    │        │    编排者     │                   │
│  └──────────────┘       └──────────────┘                   │
│         ↑                      ↓                           │
│  ┌──────────────┐       ┌──────────────┐                   │
│  │  Evaluator   │←──────│ Orchestrator │                   │
│  │    评估者    │        │    调度者     │                   │
│  └──────────────┘       └──────────────┘                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.1 角色定义总表

| 序号 | 角色 | 中文名 | 职能组 | 核心职责 |
|------|------|--------|--------|----------|
| 1 | **Researcher** | 情报研究员 | 情报组 | 检索外部最佳实践、行业标准、前沿方法 |
| 2 | **Asset Manager** | 资产管家 | 情报组 | 管理内部Agent模板、Prompt组件、流程蓝图 |
| 3 | **Architect** | 架构师 | 设计组 | 拆解意图，设计智能体蓝图和I/O契约 |
| 4 | **Weaver** | 织造者 | 设计组 | 编写System Prompt，赋予智能体灵魂 |
| 5 | **Choreographer** | 编排者 | 执行组 | 设计协作拓扑（DAG/状态机），定义数据流转 |
| 6 | **Orchestrator** | 调度者 | 执行组 | 运行时调度执行，管理上下文传递 |
| 7 | **Evaluator** | 评估者 | 运维组 | 质量评估，拥有最终否决权 |
| 8 | **Learner** | 学习者 | 运维组 | 从历史中提取模式，优化系统 |

### 2.2 各角色详细定义

#### 2.2.1 Researcher（情报研究员）

**职责**：检索外部世界的最佳实践、SOP、行业标准

**输入**：用户查询领域、任务描述

**输出**：
```json
{
  "domain": "医疗问诊",
  "best_practices": ["SOAP记录法", "分诊标准"],
  "recommended_roles": ["分诊员", "问诊员", "诊断员"],
  "common_pitfalls": ["漏问病史", "误诊风险"],
  "sources": ["..."],
  "confidence": 0.85
}
```

**技能**：Web搜索、RAG检索、知识提纯、文献分析

**边界**：只提供情报，不做架构决策

#### 2.2.2 Asset Manager（资产管家）

**职责**：管理内部已有的Agent模板、Prompt组件、流程蓝图

**输入**：用户查询、系统上下文

**输出**：
```json
{
  "matched": true,
  "reusable_agents": ["问诊员-v2.1", "诊断员-v1.3"],
  "reusable_workflows": ["医疗问诊流程-v1.0"],
  "reuse_rate": 0.7,
  "gaps": ["缺少分诊员"]
}
```

**技能**：语义检索、版本控制、资产匹配

**边界**：只负责存取，不创造新资产

#### 2.2.3 Architect（架构师）

**职责**：拆解意图，定义所需Agent列表、职能边界、I/O契约

**输入**：Researcher情报 + Asset Manager资产匹配结果

**输出**：
```json
{
  "blueprint_name": "医疗问诊系统",
  "agents": [
    {"name": "分诊员", "role": "初步分类", "input": "症状描述", "output": "科室建议"}
  ],
  "contracts": {"分诊员→问诊员": "患者基本信息+科室"},
  "workflow_type": "seq"
}
```

**技能**：系统设计、任务分解、契约定义

**边界**：只设计蓝图，不写Prompt，不管流程细节

#### 2.2.4 Weaver（织造者）

**职责**：编写System Prompt，注入角色性格、思维框架、输出约束

**输入**：Architect的蓝图

**输出**：
```json
{
  "agent_name": "分诊员",
  "system_prompt": "你是一名经验丰富的分诊护士...",
  "components": {
    "role_play": "分诊护士，10年经验",
    "task_context": "根据患者症状进行初步分类",
    "thinking_process": "先问主诉，再问病史",
    "output_constraint": "输出JSON格式的分诊结果"
  }
}
```

**技能**：Prompt工程、Few-Shot设计、多模型适配

**边界**：只写单个Agent的Prompt，不管Agent之间如何协作

#### 2.2.5 Choreographer（编排者）

**职责**：设计Agent间的协作拓扑（DAG/状态机），定义数据流转规则

**输入**：Architect的蓝图 + Weaver的Agent配置

**输出**：
```json
{
  "topology": "DAG",
  "nodes": [
    {"id": "triage", "agent": "分诊员", "next": ["inquiry"]},
    {"id": "inquiry", "agent": "问诊员", "next": ["diagnosis"]}
  ],
  "transitions": [
    {"from": "triage", "to": "inquiry", "condition": "triage.success"}
  ],
  "error_handling": {"on_failure": "retry_then_escalate"}
}
```

**技能**：流程建模、状态机设计、条件逻辑

**边界**：只设计流程拓扑，不负责运行时执行

#### 2.2.6 Orchestrator（调度者）

**职责**：运行时调度执行，管理上下文传递，处理异常

**输入**：Choreographer的流程定义 + 实际任务数据

**输出**：
```json
{
  "execution_id": "exec-001",
  "status": "completed",
  "results": [
    {"agent": "分诊员", "status": "success", "output": {...}},
    {"agent": "问诊员", "status": "success", "output": {...}}
  ],
  "duration_ms": 5000
}
```

**技能**：任务调度、上下文路由、异常处理、重试机制

**边界**：只负责执行，不修改流程设计

#### 2.2.7 Evaluator（评估者）

**职责**：质量评估，验证逻辑一致性，拥有最终否决权

**输入**：执行结果 + 原始计划

**输出**：
```json
{
  "scores": {"accuracy": 0.9, "completeness": 0.85, "efficiency": 0.8},
  "overall": 0.87,
  "pass": true,
  "feedback": ["整体良好", "建议增加异常处理"],
  "action": "approve"
}
```

**技能**：评分标准应用、对抗测试、一致性校验

**边界**：只评估，不修改；但有否决权

#### 2.2.8 Learner（学习者）

**职责**：从历史执行中提取模式，优化Prompt和流程

**输入**：历史执行记录 + 评估反馈

**输出**：
```json
{
  "patterns_found": ["问诊时先问主诉效果更好"],
  "suggestions": {
    "prompt_improvements": ["分诊员增加急症识别"],
    "workflow_improvements": ["增加复诊分支"]
  }
}
```

**技能**：模式识别、Few-Shot学习、优化建议生成

**边界**：只提建议，不直接修改系统

## 3. 职能边界与协同

### 3.1 职能边界矩阵

| 角色 | 知道什么 | 不知道什么 | 能做什么 | 不能做什么 |
|------|----------|------------|----------|------------|
| Researcher | 外部最佳实践 | 内部资产 | 搜索、分析 | 架构决策 |
| Asset Manager | 内部资产库 | 外部趋势 | 存取、匹配 | 创造新资产 |
| Architect | 全局蓝图 | Prompt细节 | 设计架构 | 写Prompt |
| Weaver | 单个Agent | 流程拓扑 | 写Prompt | 设计流程 |
| Choreographer | 流程拓扑 | Prompt内容 | 设计流程 | 运行时执行 |
| Orchestrator | 执行状态 | 设计意图 | 调度执行 | 修改设计 |
| Evaluator | 质量标准 | 实现细节 | 评估、否决 | 直接修改 |
| Learner | 历史模式 | 当前执行 | 提建议 | 直接修改 |

### 3.2 协同流程

```
用户意图
    ↓
┌─────────────────────────────────────────┐
│ [1] Researcher ←并行→ Asset Manager     │
│     (外部情报)        (内部资产)         │
└─────────────────────────────────────────┘
    ↓ 合并报告
┌─────────────────────────────────────────┐
│ [2] Architect (设计蓝图)                 │
└─────────────────────────────────────────┘
    ↓ 蓝图
┌─────────────────────────────────────────┐
│ [3] Weaver ←并行→ Choreographer         │
│     (写Prompt)      (设计流程)           │
└─────────────────────────────────────────┘
    ↓ 完整配置
┌─────────────────────────────────────────┐
│ [4] Orchestrator (运行时执行)            │
└─────────────────────────────────────────┘
    ↓ 执行结果
┌─────────────────────────────────────────┐
│ [5] Evaluator (质量评估)                 │
│     ├─ 通过 → Asset Manager存档          │
│     └─ 不通过 → 打回对应环节              │
└─────────────────────────────────────────┘
    ↓ 历史记录
┌─────────────────────────────────────────┐
│ [6] Learner (学习优化)                   │
└─────────────────────────────────────────┘
```

## 4. 层级派生机制

### 4.1 核心概念

派生 = **继承** + **特化** + **约束**

| 维度 | 说明 | 示例 |
|------|------|------|
| **继承** | 子智能体获得父智能体的基础能力 | 胃肠科继承内科的问诊能力 |
| **特化** | 在特定领域深化专业能力 | 增加胃镜解读能力 |
| **约束** | 缩小职责边界 | 只处理消化系统疾病 |

### 4.2 派生树结构

```
L0 通用智能体
 │
 ├─ L1 领域智能体
 │   │
 │   ├─ L2 专科智能体
 │   │   │
 │   │   └─ L3 细分智能体
```

**示例：医疗场景**
```
医生 (L0)
├── 内科医生 (L1)
│   ├── 胃肠科医生 (L2)
│   │   ├── 胃镜专家 (L3)
│   │   └── 肠镜专家 (L3)
│   └── 心血管科医生 (L2)
└── 外科医生 (L1)
    └── 骨科医生 (L2)
```

### 4.3 派生规则

**触发条件**：
| 条件 | 说明 |
|------|------|
| 粒度不足 | 当前智能体无法处理细分问题 |
| 质量不达标 | Evaluator反馈准确率低于阈值 |
| 频率阈值 | 某类子任务频繁出现 |

**派生流程**：
1. Evaluator/Orchestrator 识别能力缺口
2. Researcher 研究该细分领域
3. Architect 设计子智能体边界
4. Weaver 基于父Prompt编写特化Prompt
5. Evaluator 验证子智能体
6. Asset Manager 注册并建立父子关系

### 4.4 派生数据结构

**父智能体**：
```json
{
  "id": "internal-medicine-001",
  "name": "内科医生",
  "level": 1,
  "prompt": "你是一名内科医生...",
  "skills": ["问诊", "诊断", "开药"],
  "constraints": ["不做手术"]
}
```

**子智能体**（派生后）：
```json
{
  "id": "gastro-001",
  "name": "胃肠科医生",
  "level": 2,
  "parent_id": "internal-medicine-001",
  "prompt": "你是一名胃肠科专家...",
  "inherited_skills": ["问诊", "诊断", "开药"],
  "new_skills": ["胃镜解读", "肠镜解读"],
  "inherited_constraints": ["不做手术"],
  "new_constraints": ["只处理消化系统疾病"]
}
```

### 4.5 层级间协作路由

| 场景 | 路由策略 |
|------|----------|
| 问题明确属于某专科 | 直接路由到专科智能体 |
| 问题涉及多个专科 | 并行分发，结果汇总 |
| 超出当前层级能力 | 向下派生或向上回退 |
| 专科智能体不存在 | 触发派生流程 |

## 5. 设计哲学

### 5.1 核心原则

| 原则 | 说明 |
|------|------|
| **解耦** | 各角色职责单一，互不侵入 |
| **资产为王** | 复用优先，避免重复造轮子 |
| **闭环验收** | Evaluator拥有否决权 |
| **持续进化** | Learner驱动系统优化 |

### 5.2 信息隔离

- Weaver 不知道流程拓扑
- Choreographer 不知道Prompt内容
- 这种隔离保证单个角色的**通用性**和**稳定性**
